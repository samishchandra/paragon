<!doctype html>
<html lang="en">

  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1, viewport-fit=cover" />
    <title>Momentum Notes</title>
    <meta name="description" content="A modern note-taking and task management app" />
    <meta name="theme-color" content="#059669" />

    <!-- Favicon & Icons -->
    <link rel="icon" type="image/x-icon" href="https://files.manuscdn.com/user_upload_by_module/session_file/310519663318957742/UIsACxOIZZCdOYSQ.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="https://files.manuscdn.com/user_upload_by_module/session_file/310519663318957742/ZmFYosFtNuHNAeqL.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="https://files.manuscdn.com/user_upload_by_module/session_file/310519663318957742/QzBngxBiEWBxxiys.png" />

    <!-- PWA Manifest (crossorigin needed for Manus OAuth proxy) -->
    <link rel="manifest" href="/manifest.json" crossorigin="use-credentials" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Momentum Notes" />

    <!-- Open Graph -->
    <meta property="og:title" content="Momentum Notes" />
    <meta property="og:description" content="A modern note-taking and task management app" />
    <meta property="og:image" content="https://files.manuscdn.com/user_upload_by_module/session_file/310519663318957742/OMhpFAGCDflzlAWO.png" />
    <meta property="og:type" content="website" />


    <!-- Preconnect to critical origins -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://files.manuscdn.com" />
    <link rel="dns-prefetch" href="https://fonts.googleapis.com" />
    <link rel="dns-prefetch" href="https://fonts.gstatic.com" />

    <!-- Fonts: preload the CSS to avoid render-blocking, then load async -->
    <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'" />
    <noscript>
      <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet" />
    </noscript>

    <!-- Splash Screen Styles -->
    <style>
      #splash-screen {
        position: fixed;
        inset: 0;
        z-index: 99999;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: #f8fafc;
        transition: opacity 0.4s ease, visibility 0.4s ease;
      }

      #splash-screen.fade-out {
        opacity: 0;
        visibility: hidden;
      }
      #splash-screen .splash-icon {
        width: 72px;
        height: 72px;
        border-radius: 16px;
        animation: splash-breathe 2s ease-in-out infinite;
      }
      @keyframes splash-breathe {
        0%, 100% { transform: scale(1); opacity: 0.9; }
        50% { transform: scale(1.08); opacity: 1; }
      }
      #splash-screen .splash-text {
        margin-top: 20px;
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
        font-size: 18px;
        font-weight: 600;
        color: #1e293b;
        letter-spacing: -0.01em;
      }
      #splash-screen .splash-dots {
        display: flex;
        gap: 6px;
        margin-top: 24px;
      }
      #splash-screen .splash-dots span {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #cbd5e1;
        animation: splash-dot 1.4s ease-in-out infinite;
      }
      #splash-screen .splash-dots span.active {
        background: #059669;
      }
      #splash-screen .splash-dots span:nth-child(1) { animation-delay: 0s; }
      #splash-screen .splash-dots span:nth-child(2) { animation-delay: 0.2s; }
      #splash-screen .splash-dots span:nth-child(3) { animation-delay: 0.4s; }
      @keyframes splash-dot {
        0%, 80%, 100% { transform: scale(1); opacity: 0.4; }
        40% { transform: scale(1.3); opacity: 1; }
      }
    </style>
  </head>

  <body>
    <!-- NUCLEAR: Kill all service workers and clear caches on every load to break stale cache cycle -->
    <script>
      (function() {
        // Unregister ALL service workers immediately
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.getRegistrations().then(function(regs) {
            regs.forEach(function(r) { r.unregister(); });
          }).catch(function() {});
        }
        // Clear ALL caches
        if ('caches' in window) {
          caches.keys().then(function(keys) {
            keys.forEach(function(k) { caches.delete(k); });
          }).catch(function() {});
        }
      })();
    </script>

    <!-- Pre-React error display: show JS errors visibly instead of blank screen -->
    <script>
      window.__preReactErrors = [];
      window.onerror = function(msg, src, line, col, err) {
        window.__preReactErrors.push(msg + ' at ' + src + ':' + line);
        var el = document.getElementById('pre-react-error');
        if (!el) {
          el = document.createElement('div');
          el.id = 'pre-react-error';
          el.style.cssText = 'position:fixed;bottom:0;left:0;right:0;z-index:999999;background:#fee;color:#900;padding:12px;font:12px monospace;max-height:40vh;overflow:auto;';
          document.body.appendChild(el);
        }
        el.textContent = 'JS Error: ' + window.__preReactErrors.join(' | ');
      };
    </script>

    <!-- Loading Splash Screen -->
    <div id="splash-screen">
      <img
        src="https://files.manuscdn.com/user_upload_by_module/session_file/310519663318957742/QzBngxBiEWBxxiys.png"
        alt="Momentum Notes"
        class="splash-icon"
      />
      <div class="splash-text">Momentum Notes</div>
      <div class="splash-dots">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>

    <div id="root"></div>
    <script>
      // Global function to dismiss the splash screen, called by React once ready
      window.__dismissSplash = function() {
        var splash = document.getElementById('splash-screen');
        if (splash && !splash.classList.contains('fade-out')) {
          splash.classList.add('fade-out');
          setTimeout(function() { splash.remove(); }, 500);
        }
      };
      // Safety net: auto-dismiss after 10 seconds in case React never calls it
      setTimeout(function() { window.__dismissSplash && window.__dismissSplash(); }, 10000);
    </script>
    <script type="module" src="/src/main.tsx"></script>
    <!-- Chunk loading error recovery: clear SW caches and reload on stale chunks -->
    <script>
      function isChunkError(msg) {
        return msg && (
          msg.includes('Unexpected token') ||
          msg.includes('Failed to fetch dynamically imported module') ||
          msg.includes('Loading chunk') ||
          msg.includes('error loading dynamically imported module') ||
          msg.includes('Importing a module script failed')
        );
      }
      function recoverFromStaleCache() {
        var reloaded = sessionStorage.getItem('chunk-error-reload');
        if (reloaded) {
          sessionStorage.removeItem('chunk-error-reload');
          return; // Already tried once, don't loop
        }
        sessionStorage.setItem('chunk-error-reload', '1');
        // 1. Tell SW to clear all caches
        if (navigator.serviceWorker && navigator.serviceWorker.controller) {
          navigator.serviceWorker.controller.postMessage({ type: 'CLEAR_CACHES' });
        }
        // 2. Clear caches directly via Cache API
        if ('caches' in window) {
          caches.keys().then(function(keys) {
            return Promise.all(keys.map(function(k) { return caches.delete(k); }));
          }).then(function() {
            window.location.reload();
          }).catch(function() {
            window.location.reload();
          });
        } else {
          window.location.reload();
        }
      }
      // Catch synchronous script errors (e.g., syntax errors from HTML served as JS)
      window.addEventListener('error', function(e) {
        if (isChunkError(e.message)) recoverFromStaleCache();
      });
      // Catch async import() failures
      window.addEventListener('unhandledrejection', function(e) {
        var msg = e.reason && (e.reason.message || String(e.reason));
        if (isChunkError(msg)) recoverFromStaleCache();
      });
      // Clear the reload flag on successful load
      window.addEventListener('load', function() {
        sessionStorage.removeItem('chunk-error-reload');
      });
    </script>
    <script
      defer
      src="%VITE_ANALYTICS_ENDPOINT%/umami"
      data-website-id="%VITE_ANALYTICS_WEBSITE_ID%"
      onerror="this.remove()"></script>
  </body>

</html>
